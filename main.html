<!-- Nofee AI – 안정화 버전 -->
<div id='nofee-ai-wrapper'>
  <!-- CSS 로드 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Jacob-PO/nofee_chat@main/main.css">
  
  <!-- 폴백 스타일 -->
  <style>
    #nofee-ai-wrapper {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 9999;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .nofee-chat-container {
      width: 100%;
      height: 100%;
      background: #f9faff;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .nofee-header {
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px 20px;
      flex-shrink: 0;
    }
    .nofee-chat-wrapper {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .nofee-loading {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
  </style>

  <!-- 메인 컨테이너 -->
  <div class='nofee-chat-container'>
    <!-- 헤더 -->
    <div class='nofee-header'>
      <div class='nofee-header-content'>
        <div class='nofee-header-left'>
          <div class='nofee-profile-img'>
            <svg width='28' height='28' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2'>
              <path d='M12 2L2 7L12 12L22 7L12 2Z'/>
              <path d='M2 17L12 22L22 17'/>
              <path d='M2 12L12 17L22 12'/>
            </svg>
          </div>
          <div class='nofee-header-text'>
            <h3>노피 AI</h3>
            <p>최저가 휴대폰 추천 서비스</p>
          </div>
        </div>
      </div>
    </div>

    <!-- 채팅 영역 -->
    <div class='nofee-chat-wrapper' id='nofeeChat'>
      <!-- 로딩 -->
      <div class='nofee-loading' id='nofeeLoading'>
        <div class='nofee-loading-spinner'></div>
        <p>AI를 준비하고 있습니다...</p>
        <small>잠시만 기다려주세요</small>
      </div>
      
      <!-- 인트로 -->
      <div class='nofee-intro-section' id='nofeeIntro' style='display:none'>
        <div class='nofee-intro-content'>
          <div class='nofee-intro-avatar'>
            <svg width='60' height='60' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='1.5'>
              <path d='M12 2L2 7L12 12L22 7L12 2Z'/>
              <path d='M2 17L12 22L22 17'/>
              <path d='M2 12L12 17L22 12'/>
            </svg>
          </div>
          <h2>안녕하세요! 👋</h2>
          <p>최적의 휴대폰을 찾아드리는<br>노피 AI입니다</p>
          <button class='nofee-start-btn' id='startConsultBtn'>
            AI 상담 시작하기
          </button>
        </div>
      </div>
      
      <!-- 메시지 컨테이너 -->
      <div class='nofee-messages-container' id='nofeeMessages' style='display:none'></div>
    </div>

    <!-- AI 생각중 -->
    <div class='nofee-ai-thinking' id='aiThinking' style='display:none'>
      <div class='nofee-thinking-content'>
        <div class='nofee-ai-dots'>
          <div class='nofee-ai-dot'></div>
          <div class='nofee-ai-dot'></div>
          <div class='nofee-ai-dot'></div>
        </div>
        <span class='nofee-ai-thinking-text'>AI가 분석 중입니다...</span>
      </div>
    </div>
  </div>

  <!-- 웹플로우 폼 (숨김) -->
  <form id='nofee-purchase-form' name='purchase' data-name='Purchase Form' style='position:absolute;left:-9999px;visibility:hidden;'>
    <input type='hidden' name='customer_name' id='customer_name'>
    <input type='hidden' name='customer_phone' id='customer_phone'>
    <input type='hidden' name='customer_region' id='customer_region'>
    <input type='hidden' name='customer_district' id='customer_district'>
    <input type='hidden' name='privacy_consent' id='privacy_consent' value=''>
    <input type='hidden' name='phone_model' id='phone_model'>
    <input type='hidden' name='phone_carrier' id='phone_carrier'>
    <input type='hidden' name='phone_plan' id='phone_plan'>
    <input type='hidden' name='phone_price' id='phone_price'>
    <input type='hidden' name='monthly_payment' id='monthly_payment'>
    <input type='hidden' name='contract_type' id='contract_type'>
    <input type='hidden' name='activation_type' id='activation_type'>
    <input type='hidden' name='timestamp' id='timestamp'>
    <input type='hidden' name='session_id' id='session_id'>
  </form>

  <!-- 스크립트 -->
  <script>
    // DOM 준비 확인
    function waitForDOM(callback) {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', callback);
      } else {
        callback();
      }
    }
    
    // 초기화
    waitForDOM(function() {
      // 폼 이벤트 리스너 (안전하게)
      const form = document.getElementById('nofee-purchase-form');
      if (form) {
        form.addEventListener('submit', function(e) {
          const consent = document.getElementById('privacy_consent');
          if (!consent || consent.value !== '동의함') {
            e.preventDefault();
            console.log('개인정보 동의 필요');
            return false;
          }
        });
      }
      
      // 시작 버튼 이벤트
      const startBtn = document.getElementById('startConsultBtn');
      if (startBtn) {
        startBtn.onclick = function() {
          if (window.NofeeAI && window.NofeeAI.startConsultation) {
            window.NofeeAI.startConsultation();
          }
        };
      }
      
      // 메인 스크립트 로드
      loadNofeeScript();
    });
    
    // 스크립트 로드
    function loadNofeeScript() {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/gh/Jacob-PO/nofee_chat@main/main.js?v=' + Date.now();
      script.onload = function() {
        console.log('노피 AI 스크립트 로드 완료');
        if (window.NofeeAI && window.NofeeAI.init) {
          window.NofeeAI.init();
        }
      };
      script.onerror = function() {
        console.error('스크립트 로드 실패');
        const loading = document.getElementById('nofeeLoading');
        if (loading) {
          loading.innerHTML = 
            '<p style="color:#ef4444">초기화에 실패했습니다</p>' +
            '<button onclick="location.reload()" style="margin-top:16px;padding:10px 24px;background:#4e5bff;color:white;border:none;border-radius:24px;cursor:pointer;font-weight:600">다시 시도</button>';
        }
      };
      document.head.appendChild(script);
    }
  </script>
</div>
