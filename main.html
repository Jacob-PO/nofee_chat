<!-- Nofee AI – 개선된 단일 페이지 임베드 -->
<div id='nofee-ai-wrapper' class='ai-theme'>
  <!-- CSS 로드 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Jacob-PO/nofee_chat@main/main.css">
  
  <!-- 대체 CSS (CDN 실패 시) -->
  <style>
    /* 최소한의 폴백 스타일 */
    #nofee-ai-wrapper {
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    .nofee-chat-container {
      min-height: 100vh;
      background: #f9faff;
      position: relative;
    }
    .nofee-loading {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }
  </style>

  <!-- ==========  구조  ========== -->
  <div class='nofee-chat-container'>
    <!-- 헤더 -->
    <div class='nofee-header'>
      <div class='nofee-header-left'>
        <button class='nofee-back-btn' onclick='window.history.back()' aria-label='뒤로'>
          <svg width='24' height='24' viewBox='0 0 24 24' fill='none'>
            <path d='M15 18L9 12L15 6' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
          </svg>
        </button>
        <div class='nofee-profile-img'>🤖</div>
        <div class='nofee-header-text'>
          <h3>노피 AI 매니저</h3>
          <p>최적의 휴대폰을 찾아드려요</p>
        </div>
      </div>
      <div class='nofee-header-actions'>
        <button class='nofee-menu-btn' aria-label='메뉴'>
          <svg width='24' height='24' viewBox='0 0 24 24' fill='none'>
            <circle cx='12' cy='5' r='2' fill='currentColor'/>
            <circle cx='12' cy='12' r='2' fill='currentColor'/>
            <circle cx='12' cy='19' r='2' fill='currentColor'/>
          </svg>
        </button>
        <button class='nofee-close-btn' onclick='location.reload()' aria-label='닫기'>
          <svg width='24' height='24' viewBox='0 0 24 24' fill='none'>
            <path d='M18 6L6 18M6 6L18 18' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
          </svg>
        </button>
      </div>
    </div>

    <!-- 메시지 영역 -->
    <div class='nofee-chat-messages' id='nofeeChat'>
      <div class='nofee-loading' id='nofeeLoading'>
        노피 AI를 준비하고 있습니다...<br>
        <small>잠시만 기다려주세요 💙</small>
      </div>
      
      <div class='nofee-intro-section' id='nofeeIntro' style='display:none'>
        <div class='nofee-intro-avatar'>💙</div>
        <h2>노피 AI 매니저에 문의하기</h2>
        <div class='nofee-time-badge' onclick='toggleOperatingHours()'>운영시간 보기 ›</div>
      </div>
      
      <div class='nofee-operating-hours' id='operatingHours' style='display:none'>
        <p>평일: 오전 10:00 - 오후 7:00</p>
        <p>주말: 오전 11:00 - 오후 6:00</p>
        <p>공휴일: 휴무</p>
      </div>
    </div>

    <!-- AI 생각중 -->
    <div class='nofee-ai-thinking' id='aiThinking' style='display:none'>
      <div class='nofee-ai-dots'>
        <div class='nofee-ai-dot'></div>
        <div class='nofee-ai-dot'></div>
        <div class='nofee-ai-dot'></div>
      </div>
      <div class='nofee-ai-thinking-text'>AI가 분석 중입니다...</div>
    </div>

    <!-- 하단 액션 바 -->
    <div class='nofee-input-area'>
      <button class='nofee-action-btn nofee-home-btn' id='homeBtn' aria-label='홈'>
        <svg width='20' height='20' viewBox='0 0 24 24' fill='none'>
          <path d='M3 9L12 2L21 9V20C21 20.53 20.79 21.04 20.41 21.41C20.04 21.79 19.53 22 19 22H5C4.47 22 3.96 21.79 3.59 21.41C3.21 21.04 3 20.53 3 20V9Z' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
          <path d='M9 22V12H15V22' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
        </svg>
      </button>
      <button class='nofee-action-btn' id='phoneBtn' aria-label='상품보기'>
        <svg width='20' height='20' viewBox='0 0 24 24' fill='none'>
          <rect x='5' y='2' width='14' height='20' rx='2' stroke='currentColor' stroke-width='2'/>
          <circle cx='12' cy='18' r='1' fill='currentColor'/>
        </svg>
      </button>
      <button class='nofee-action-btn' id='deliveryBtn' aria-label='배송정보' style='background:#6d8bff'>
        <svg width='20' height='20' viewBox='0 0 24 24' fill='none'>
          <path d='M10 12V17H4V12H10ZM10 12H16M16 12V7H20V12H16ZM16 12V17' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/>
          <circle cx='7' cy='19' r='2' stroke='white' stroke-width='2'/>
          <circle cx='17' cy='19' r='2' stroke='white' stroke-width='2'/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Webflow 폼 (개인정보 동의 후에만 제출 가능) -->
  <form id='nofee-purchase-form' name='purchase' data-name='Purchase Form' style='display:none'>
    <input type='hidden' name='customer_name' id='customer_name'>
    <input type='hidden' name='customer_phone' id='customer_phone'>
    <input type='hidden' name='customer_region' id='customer_region'>
    <input type='hidden' name='customer_district' id='customer_district'>
    <input type='hidden' name='privacy_consent' id='privacy_consent' value=''>
    <input type='hidden' name='phone_model' id='phone_model'>
    <input type='hidden' name='phone_carrier' id='phone_carrier'>
    <input type='hidden' name='phone_plan' id='phone_plan'>
    <input type='hidden' name='phone_price' id='phone_price'>
    <input type='hidden' name='monthly_payment' id='monthly_payment'>
    <input type='hidden' name='contract_type' id='contract_type'>
    <input type='hidden' name='activation_type' id='activation_type'>
    <input type='hidden' name='timestamp' id='timestamp'>
    <input type='hidden' name='session_id' id='session_id'>
    <input type='hidden' name='utm_source' id='utm_source'>
    <input type='hidden' name='utm_medium' id='utm_medium'>
    <input type='hidden' name='utm_campaign' id='utm_campaign'>
    <input type='submit' value='Submit' id='nofee-submit-btn'>
  </form>

  <!-- 스크립트 -->
  <script>
    // 운영시간 토글
    function toggleOperatingHours() {
      const hours = document.getElementById('operatingHours');
      if (hours) {
        hours.style.display = hours.style.display === 'none' ? 'block' : 'none';
      }
    }
    
    // 폼 제출 방지 (개인정보 동의 전)
    document.getElementById('nofee-purchase-form').addEventListener('submit', function(e) {
      const consent = document.getElementById('privacy_consent').value;
      if (consent !== '동의함') {
        e.preventDefault();
        console.log('개인정보 처리방침 동의가 필요합니다.');
        return false;
      }
    });
    
    // 메인 스크립트 로드
    function loadNofeeScript() {
      const candidates = [
        'https://cdn.jsdelivr.net/gh/Jacob-PO/nofee_chat@main/main.js',
        'https://jacob-po.github.io/nofee_chat/main.js'
      ];
      
      Promise.any(candidates.map(src => 
        new Promise((resolve, reject) => {
          const script = document.createElement('script');
          script.src = src + '?v=' + Date.now();
          script.onload = () => window.NofeeAI?.init ? resolve(src) : reject();
          script.onerror = reject;
          document.head.appendChild(script);
        })
      ))
      .then(() => {
        // 버튼 이벤트 설정
        document.getElementById('homeBtn').onclick = () => window.NofeeAI?.resetChat();
        document.getElementById('phoneBtn').onclick = () => window.NofeeAI?.showPhoneList();
        document.getElementById('deliveryBtn').onclick = () => window.NofeeAI?.showDeliveryInfo();
        
        // 초기화
        window.NofeeAI.init();
      })
      .catch(() => {
        document.getElementById('nofeeLoading').innerHTML = 
          '스크립트를 불러오지 못했습니다.<br>' +
          '<button onclick="location.reload()" style="margin-top:10px;padding:8px 16px;background:#4e5bff;color:white;border:none;border-radius:20px;cursor:pointer">새로고침</button>';
      });
    }
    
    // 즉시 실행
    loadNofeeScript();
  </script>
</div>
